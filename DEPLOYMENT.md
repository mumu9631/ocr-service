# PaddleOCRé£Ÿå“æ ‡ç­¾è¯†åˆ«æœåŠ¡ - å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–¹æ¡ˆé‡‡ç”¨**Python FastAPIæœåŠ¡ + Railway.appéƒ¨ç½²**çš„æ–¹å¼ï¼Œä¸ºå¾®ä¿¡å°ç¨‹åºæä¾›é£Ÿå“æ ‡ç­¾OCRè¯†åˆ«èƒ½åŠ›ã€‚

### æŠ€æœ¯æ¶æ„

```
å¾®ä¿¡å°ç¨‹åº
    â†“ (Base64å›¾ç‰‡)
Railway.app OCRæœåŠ¡ (PaddleOCR)
    â†“ (JSONè¯†åˆ«ç»“æœ)
æ ¼å¼åŒ–è¾“å‡º
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: å‡†å¤‡ä»£ç 

```bash
# è¿›å…¥OCRæœåŠ¡ç›®å½•
cd ocr-service

# æŸ¥çœ‹æ–‡ä»¶ç»“æ„
ls -la
```

**ç›®å½•ç»“æ„**:
```
ocr-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPIä¸»åº”ç”¨
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ ocr_engine.py    # PaddleOCRå¼•æ“å°è£…
â”œâ”€â”€ requirements.txt         # Pythonä¾èµ–
â”œâ”€â”€ railway.json            # Railwayé…ç½®
â”œâ”€â”€ Procfile                # å¯åŠ¨å‘½ä»¤
â””â”€â”€ README.md               # ä½¿ç”¨è¯´æ˜
```

### æ­¥éª¤2: æ¨é€ä»£ç åˆ°GitHub

```bash
# åˆå§‹åŒ–Gitä»“åº“ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
git init

# æ·»åŠ æ‰€æœ‰æ–‡ä»¶
git add .

# æäº¤
git commit -m "Initial commit: PaddleOCR service"

# æ¨é€åˆ°GitHubï¼ˆæ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€ï¼‰
git remote add origin https://github.com/your-username/food-label-ocr.git
git push -u origin main
```

### æ­¥éª¤3: éƒ¨ç½²åˆ°Railway.app

#### æ–¹å¼A: é€šè¿‡Railwayæ§åˆ¶å°ï¼ˆæ¨èï¼‰

1. è®¿é—® [railway.app](https://railway.app/) å¹¶ç™»å½•
2. ç‚¹å‡» "New Project"
3. é€‰æ‹© "Deploy from GitHub repo"
4. æˆæƒå¹¶é€‰æ‹©åˆšæ¨é€çš„ä»“åº“
5. Railwayä¼šè‡ªåŠ¨æ£€æµ‹Pythoné¡¹ç›®å¹¶å¼€å§‹éƒ¨ç½²

#### æ–¹å¼B: é€šè¿‡Railway CLI

```bash
# å®‰è£…Railway CLI
npm install -g @railway/cli

# ç™»å½•Railway
railway login

# åˆå§‹åŒ–é¡¹ç›®
cd ocr-service
railway init

# éƒ¨ç½²
railway up
```

### æ­¥éª¤4: ç­‰å¾…éƒ¨ç½²å®Œæˆ

- é¦–æ¬¡éƒ¨ç½²éœ€è¦ä¸‹è½½PaddleOCRæ¨¡å‹ï¼ˆçº¦10-20MBï¼‰ï¼Œå¯èƒ½éœ€è¦2-5åˆ†é’Ÿ
- åœ¨Railwayæ§åˆ¶å°å¯ä»¥çœ‹åˆ°éƒ¨ç½²æ—¥å¿—
- éƒ¨ç½²æˆåŠŸåä¼šæ˜¾ç¤ºç±»ä¼¼: `https://your-app-name.railway.app`

### æ­¥éª¤5: æµ‹è¯•æœåŠ¡

```bash
# å¥åº·æ£€æŸ¥
curl https://your-app-name.railway.app/health

# åº”è¿”å›:
# {"status":"healthy","model_loaded":true}
```

---

## ğŸ”§ é…ç½®å°ç¨‹åº

### æ­¥éª¤1: ä¿®æ”¹OCRæœåŠ¡åœ°å€

ç¼–è¾‘ `miniprogram/utils/ocrService.js`:

```javascript
// ä¿®æ”¹ä¸ºä½ çš„RailwayæœåŠ¡åœ°å€
const OCR_SERVICE_URL = 'https://your-app-name.railway.app/ocr/text';
```

### æ­¥éª¤2: é…ç½®æœåŠ¡å™¨åŸŸåï¼ˆé‡è¦ï¼‰

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æœåŠ¡å™¨åŸŸå:

1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥"å¼€å‘" â†’ "å¼€å‘ç®¡ç†" â†’ "å¼€å‘è®¾ç½®"
3. åœ¨"æœåŠ¡å™¨åŸŸå"ä¸­ï¼Œå°†ä½ çš„RailwayåŸŸåæ·»åŠ åˆ°:
   - **requeståˆæ³•åŸŸå**: `https://your-app-name.railway.app`

**æ³¨æ„**:
- å¼€å‘é˜¶æ®µå¯ä»¥å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"è¿›è¡Œæµ‹è¯•
- æ­£å¼å‘å¸ƒå¿…é¡»é…ç½®åˆæ³•åŸŸå

### æ­¥éª¤3: æµ‹è¯•å°ç¨‹åº

1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€é¡¹ç›®
2. è¿›å…¥"æ‹ç…§è¯†åˆ«"é¡µé¢
3. æ‹æ‘„æˆ–é€‰æ‹©é£Ÿå“æ ‡ç­¾å›¾ç‰‡
4. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„è¯†åˆ«ç»“æœ

---

## ğŸ“Š æŸ¥çœ‹è¯†åˆ«ç»“æœ

### åœ¨å°ç¨‹åºæ§åˆ¶å°æŸ¥çœ‹

è¯†åˆ«æˆåŠŸåï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºæ ¼å¼åŒ–çš„ç»“æœ:

```
========== OCRè¯†åˆ«ç»“æœ ==========
å…±è¯†åˆ«åˆ° 18 ä¸ªæ–‡æœ¬å—

[1] åŸå‘³æ··åˆåšæœç¤¼ç›’
    ç½®ä¿¡åº¦: 98.0%
    ä½ç½®: [[100,50],[300,50],[300,100],[100,100]]

[2] é…æ–™è¡¨ï¼šæ‰æ¡ƒä»ã€æ ¸æ¡ƒä»ã€è…°æœä»ã€æ¦›å­ä»ã€å¼€å¿ƒæœä»ã€å¤å¨å¤·æœ
    ç½®ä¿¡åº¦: 95.0%
    ä½ç½®: [[50,120],[350,120],[350,170],[50,170]]

...

---------- åŸå§‹æ–‡æœ¬ ----------
åŸå‘³æ··åˆåšæœç¤¼ç›’
é…æ–™è¡¨ï¼šæ‰æ¡ƒä»ã€æ ¸æ¡ƒä»ã€è…°æœä»ã€æ¦›å­ä»ã€å¼€å¿ƒæœä»ã€å¤å¨å¤·æœ
å‡€å«é‡ï¼š500g
ç”Ÿäº§æ—¥æœŸï¼š2025-04-10
...
================================
```

### è¯†åˆ«ç»“æœæ•°æ®ç»“æ„

```javascript
{
  success: true,
  message: "è¯†åˆ«æˆåŠŸ",
  data: [
    {
      text: "åŸå‘³æ··åˆåšæœç¤¼ç›’",
      confidence: 0.98,
      box: [[100, 50], [300, 50], [300, 100], [100, 100]]
    },
    // ... æ›´å¤šæ–‡æœ¬å—
  ],
  raw_text: "åŸå‘³æ··åˆåšæœç¤¼ç›’\né…æ–™è¡¨ï¼š..."
}
```

---

## ğŸ’° æˆæœ¬ä¼°ç®—

### Railway.appå®šä»·

| å¥—é¤ | ä»·æ ¼ | é…ç½® | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| Free | $0/æœˆ | 512MB RAM, $5é¢åº¦/æœˆ | å¼€å‘æµ‹è¯• |
| Pay As You Go | æŒ‰ä½¿ç”¨è®¡è´¹ | $5/æœˆèµ· | å°è§„æ¨¡åº”ç”¨ |

**é¢„ä¼°æˆæœ¬**:
- å¼€å‘é˜¶æ®µ: å…è´¹ï¼ˆ$5é¢åº¦è¶³å¤Ÿï¼‰
- ç”Ÿäº§ç¯å¢ƒ: çº¦$5-10/æœˆï¼ˆå–å†³äºè°ƒç”¨æ¬¡æ•°ï¼‰

### ä¼˜åŒ–æˆæœ¬å»ºè®®

1. **å¯ç”¨ç¼“å­˜**: ç›¸åŒå›¾ç‰‡ä¸é‡å¤è¯†åˆ«
2. **å‹ç¼©å›¾ç‰‡**: è¯†åˆ«å‰å‹ç¼©åˆ°åˆé€‚å¤§å°ï¼ˆå»ºè®®å®½åº¦1500-2000pxï¼‰
3. **è‡ªåŠ¨ä¼‘çœ **: Railwayå…è´¹å¥—é¤ä¼šè‡ªåŠ¨ä¼‘çœ æ— æµé‡çš„æœåŠ¡

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: éƒ¨ç½²å¤±è´¥

#### ç—‡çŠ¶1: pip install å¤±è´¥ (exit code: 1)

**é”™è¯¯ä¿¡æ¯**:
```
ERROR: failed to build: failed to solve: process "/bin/bash -ol pipefail -c python -m venv --copies /opt/venv && . /opt/venv/bin/activate && pip install -r requirements.txt" did not complete successfully: exit code: 1
```

**æ ¹æœ¬åŸå› **: PaddlePaddle 2.6.2 ä¸å…¼å®¹ Python 3.12ï¼ˆRailway é»˜è®¤ç‰ˆæœ¬ï¼‰

**è§£å†³æ–¹æ¡ˆ** (å·²å®æ–½):
1. åˆ›å»º `runtime.txt` æ–‡ä»¶ï¼ŒæŒ‡å®š Python ç‰ˆæœ¬ä¸º 3.10.14:
   ```
   python-3.10.14
   ```
2. ä¼˜åŒ– `requirements.txt`ï¼Œå°†ä¸¥æ ¼ç‰ˆæœ¬çº¦æŸ (`==`) æ”¹ä¸ºå®½æ¾çº¦æŸ (`>=`):
   ```txt
   fastapi>=0.104.1
   uvicorn[standard]>=0.24.0
   python-multipart>=0.0.6
   pydantic>=2.5.0
   paddlepaddle>=2.5.0
   paddleocr>=2.7.0
   opencv-python-headless>=4.8.0
   pillow>=10.0.0
   numpy>=1.24.0
   ```

#### ç—‡çŠ¶2: Nix åŒ…é”™è¯¯ (undefined variable 'libglib')

**é”™è¯¯ä¿¡æ¯**:
```
error: undefined variable 'libglib'
at /app/.nixpacks/nixpkgs-...nix:19:19
```

**æ ¹æœ¬åŸå› **: è‡ªå®šä¹‰ `nixpacks.toml` ä¸­ä½¿ç”¨äº†ä¸å­˜åœ¨çš„ Nix åŒ…å

**è§£å†³æ–¹æ¡ˆ** (å·²å®æ–½):
- **åˆ é™¤** `nixpacks.toml`ï¼Œä½¿ç”¨ Railway é»˜è®¤ Python provider
- ä»…ä¾èµ– `runtime.txt` æŒ‡å®š Python ç‰ˆæœ¬å³å¯

**å…³é”®é…ç½®æ–‡ä»¶**:
```
ocr-service/
â”œâ”€â”€ runtime.txt          # å¿…éœ€ï¼šæŒ‡å®š Python 3.10.14
â”œâ”€â”€ requirements.txt     # å·²ä¼˜åŒ–ï¼šä½¿ç”¨ >= çº¦æŸ
â”œâ”€â”€ railway.json         # Railway é…ç½®ï¼ˆä½¿ç”¨ NIXPACKS builderï¼‰
â””â”€â”€ Procfile            # å¯åŠ¨å‘½ä»¤
```

**é€šç”¨æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ `requirements.txt` ç‰ˆæœ¬å…¼å®¹æ€§
2. æŸ¥çœ‹Railwayéƒ¨ç½²æ—¥å¿—
3. ç¡®ä¿ Python ç‰ˆæœ¬ä¸ PaddlePaddle å…¼å®¹ï¼ˆæ¨è 3.10ï¼‰
4. é¿å…è‡ªå®šä¹‰ `nixpacks.toml`ï¼Œä½¿ç”¨ Railway é»˜è®¤é…ç½®

### é—®é¢˜2: å°ç¨‹åºè¯·æ±‚å¤±è´¥

**ç—‡çŠ¶**: æç¤º"OCRæœåŠ¡è°ƒç”¨å¤±è´¥"

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥RailwayæœåŠ¡æ˜¯å¦æ­£å¸¸éƒ¨ç½²: `/health`
2. ç¡®è®¤å°ç¨‹åºä¸­é…ç½®çš„æœåŠ¡åœ°å€æ­£ç¡®
3. æ£€æŸ¥å¾®ä¿¡æœåŠ¡å™¨åŸŸåé…ç½®
4. å¼€å‘é˜¶æ®µç¡®ä¿å‹¾é€‰äº†"ä¸æ ¡éªŒåˆæ³•åŸŸå"

### é—®é¢˜3: è¯†åˆ«å‡†ç¡®ç‡ä½

**ç—‡çŠ¶**: è¯†åˆ«ç»“æœä¸å®Œæ•´æˆ–æœ‰è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿æ‹æ‘„æ—¶å…‰çº¿å……è¶³
2. æ ‡ç­¾æ–‡å­—å°½é‡æ¸…æ™°å¯¹é½
3. é¿å…åå…‰å’Œæ¨¡ç³Š
4. å¯ä»¥å°è¯•å¤šæ¬¡æ‹æ‘„

### é—®é¢˜4: å“åº”é€Ÿåº¦æ…¢

**ç—‡çŠ¶**: è¯†åˆ«è€—æ—¶è¶…è¿‡10ç§’

**è§£å†³æ–¹æ¡ˆ**:
1. å‹ç¼©å›¾ç‰‡å¤§å°ï¼ˆå»ºè®®<2MBï¼‰
2. å‡çº§Railwayå¥—é¤ï¼ˆæ›´å¤šCPU/å†…å­˜ï¼‰
3. ä½¿ç”¨æ›´å¿«çš„OCRæ¨¡å‹ï¼ˆPP-OCRv4-mobileï¼‰

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å›¾ç‰‡é¢„å¤„ç†

åœ¨å°ç¨‹åºç«¯å‹ç¼©å›¾ç‰‡:

```javascript
// å‹ç¼©å›¾ç‰‡åå†ä¸Šä¼ 
wx.compressImage({
  src: imagePath,
  quality: 80,
  success: (res) => {
    // ä½¿ç”¨å‹ç¼©åçš„å›¾ç‰‡
    this.processImage(res.tempFilePath);
  }
});
```

### 2. æ¨¡å‹ä¼˜åŒ–

ä½¿ç”¨è½»é‡çº§æ¨¡å‹:

```python
# åœ¨ ocr_engine.py ä¸­é…ç½®
self.ocr = PaddleOCR(
    det_model_dir=None,  # ä½¿ç”¨è½»é‡çº§æ£€æµ‹æ¨¡å‹
    rec_model_dir=None,  # ä½¿ç”¨è½»é‡çº§è¯†åˆ«æ¨¡å‹
    use_angle_cls=False, # å…³é—­æ–¹å‘åˆ†ç±»å™¨æå‡é€Ÿåº¦
    lang="ch"
)
```

### 3. ç»“æœç¼“å­˜

ç¼“å­˜è¯†åˆ«ç»“æœ:

```javascript
// ä½¿ç”¨å›¾ç‰‡hashä½œä¸ºkey
const imageHash = getImageHash(imageBase64);
const cached = wx.getStorageSync(`ocr_${imageHash}`);
if (cached) {
  return cached;
}
```

---

## ğŸ¯ åç»­æ‰©å±•

### 1. ç»“æ„åŒ–æå–

åœ¨å½“å‰OCRæ–‡å­—è¯†åˆ«çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ å­—æ®µæå–é€»è¾‘:

```javascript
// ä»OCRç»“æœä¸­æå–13é¡¹å¼ºåˆ¶æ ‡ç¤ºå†…å®¹
function extractStructuredFields(ocrData) {
  return {
    name: extractFoodName(ocrData),
    ingredients: extractIngredients(ocrData),
    nutrition: extractNutrition(ocrData),
    // ... æ›´å¤šå­—æ®µ
  };
}
```

### 2. æ•°æ®åº“å­˜å‚¨

å°†è¯†åˆ«ç»“æœå­˜å‚¨åˆ°äº‘æ•°æ®åº“:

```javascript
// ä¿å­˜è¯†åˆ«å†å²
wx.cloud.database().collection('ocrHistory').add({
  data: {
    image: imageBase64,
    result: ocrResult,
    createTime: new Date()
  }
});
```

### 3. æ‰¹é‡è¯†åˆ«

æ”¯æŒå¤šå¼ å›¾ç‰‡è¿ç»­è¯†åˆ«:

```javascript
// æ‰¹é‡å¤„ç†
for (const image of images) {
  const result = await ocrService.recognizeText(image);
  results.push(result);
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹:
- Railwayæ–‡æ¡£: https://docs.railway.app/
- PaddleOCRæ–‡æ¡£: https://github.com/PaddlePaddle/PaddleOCR
- FastAPIæ–‡æ¡£: https://fastapi.tiangolo.com/

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ä»£ç å·²æ¨é€åˆ°GitHub
- [ ] Railwayé¡¹ç›®å·²åˆ›å»ºå¹¶éƒ¨ç½²æˆåŠŸ
- [ ] `/health` æ¥å£è¿”å›æ­£å¸¸
- [ ] å°ç¨‹åºä¸­OCRæœåŠ¡åœ°å€å·²æ›´æ–°
- [ ] å¾®ä¿¡æœåŠ¡å™¨åŸŸåå·²é…ç½®ï¼ˆæ­£å¼ç¯å¢ƒï¼‰
- [ ] æµ‹è¯•è¯†åˆ«åŠŸèƒ½æ­£å¸¸
- [ ] æ§åˆ¶å°è¾“å‡ºæ ¼å¼åŒ–ç»“æœ

---

**éƒ¨ç½²å®Œæˆåï¼Œä½ å°±å¯ä»¥å¼€å§‹ä½¿ç”¨çœŸå®çš„OCRè¯†åˆ«åŠŸèƒ½äº†ï¼** ğŸ‰
